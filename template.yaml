AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: awsdingler-serverless-api

Globals:
  Function:
    Timeout: 10
    Environment:
      Variables:
        ENV: !Ref Environment

Parameters:
  AutoScalingGroupName:
    Type: String
  Environment:
    Type: String
    Default: dev

Resources:
  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/
      Handler: app.hello
      Runtime: nodejs10.x
      Layers:
        - !Ref AlgorithmsLayer
      AutoPublishAlias: live
      DeploymentPreference:
          Type: Canary10Percent5Minutes
          Alarms:
            - !Ref HelloCanaryErrorsAlarm
      Events:
        Hello:
          Type: Api
          Properties:
            RestApiId: !Ref ServerlessApi
            Path: /hello
            Method: get

  HelloCanaryErrorsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Lambda function canary errors
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 2
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: 60
      Statistic: Sum
      Threshold: 0
      Dimensions:
        - Name: Resource
          Value: !Sub "${HelloWorldFunction}:live"
        - Name: FunctionName
          Value: !Ref HelloWorldFunction
        - Name: ExecutedVersion
          Value: !GetAtt HelloWorldFunction.Version.Version

  HelloIntegrationTests:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: integtests/
      Handler: hello.handler
      Runtime: nodejs10.x
      Environment:
        Variables:
          HELLO_LAMBDA_ENDPOINT: !Sub "https://${ServerlessApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/hello/"
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Action:
                - codepipeline:PutJobSuccessResult
                - codepipeline:PutJobFailureResult
              Resource: "*"

  KubernetesDashboard:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/
      Handler: cron.k8sDashboard
      Runtime: nodejs10.x
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          AUTO_SCALING_GROUP_NAME: !Ref AutoScalingGroupName
          RESULTS_S3_BUCKET: !Ref KubernetesDashboardResultsBucket
      Policies:
        - AmazonS3FullAccess
        - CloudWatchFullAccess
        - AmazonDynamoDBFullAccess
        - AmazonEC2ReadOnlyAccess
      Events:
        Cron:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)

  KubernetesDashboardResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET]
            AllowedOrigins: ['*']
            Id: myCORSRuleId1

  AlgorithmsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: AwsDinglerAlgorithms
      Description: Reusable algorithmic functions
      ContentUri: layers/nodejs/
      CompatibleRuntimes:
        - nodejs10.x
      LicenseInfo: 'MIT-0'

  ServerlessApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      DefinitionBody:
        swagger: "2.0"
        info:
          version: "1.0"
          title: "awsdingler-api"
        host: "api.awsdingler.com"
        basePath: "/v1"
        schemes:
          - "https"
        consumes:
          - application/json
        produces:
          - application/json
        securityDefinitions:
          cognitoUserPool:
            type: apiKey
            name: "Authorization"
            in: header
            x-amazon-apigateway-authtype: cognito_user_pools
            x-amazon-apigateway-authorizer:
              type: cognito_user_pools
              providerARNs:
                - Fn::Sub: "arn:aws:cognito-idp:us-west-2:${AWS::AccountId}:userpool/us-west-2_IccpkvFLy"
        paths:
          /hello:
            get:
              responses: {}
              x-amazon-apigateway-integration:
                uri: 
                  Fn::Sub: "arn:aws:apigateway:us-west-2:lambda:path/2015-03-31/functions/${HelloWorldFunction.Arn}:live/invocations"
                passthroughBehavior: "when_no_match"
                httpMethod: "POST"
                type: "aws_proxy"
          /k8s/hello:
            get:
              responses: {}
              x-amazon-apigateway-integration:
                httpMethod: "GET"
                type: "http_proxy"
                uri: "http://a9a12520b4aa911e980ba02198db823a-ebc7c7512f5f4297.elb.us-west-2.amazonaws.com/"
                passthroughBehavior: "when_no_match"
                responses:
                  default:
                    statusCode: "200"
